---
import { Icon } from 'astro-icon/components';
import { trimSlash } from '~/utils/permalinks';
import { getLangFromUrl, useTranslations, findBreadcrumbTrail } from '~/utils/i18n';
import type { MenuLink } from './Header.astro';
import { getHeader } from '~/utils/i18n';

export interface Props {
  btn: MenuLink;
  links: MenuLink[];
}

interface DropdownMenuLink extends MenuLink {
  colsClass?: string
}

const { btn, links } = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;

const language = getLangFromUrl(Astro.url);
const t = useTranslations(language);

const getLinks = (currentLinks: MenuLink[]): DropdownMenuLink[] => {
  if (!currentLinks.length || currentLinks[0].links) {
    return currentLinks;
  }

  return [
    {
      _id: btn._id,
      text: btn.text,
      href: btn.href,
      title: btn.title,
      links: currentLinks,
      colsClass: currentLinks.length > 15 ? 'md:grid-cols-2 lg:grid-cols-3 min-[1870px]:grid-cols-4' : 'md:grid-cols-2',
    },
  ];
};

let breadcrumbTrail = findBreadcrumbTrail(getHeader(language).links, currentPath);
if(breadcrumbTrail && breadcrumbTrail[0] && breadcrumbTrail[0].text === btn.text && !links[0].links) {
  breadcrumbTrail = [breadcrumbTrail[0], ...breadcrumbTrail];
}

---

<button type="button" class:list={[
  'hover:text-link dark:hover:text-white px-2 lg:px-4 py-3 flex items-center whitespace-nowrap md:text-sm min-[810px]:text-base',
  { 'active':  breadcrumbTrail && breadcrumbTrail[0] && breadcrumbTrail[0].text === btn.text},
]}>
  {btn.text}{' '}
  <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ml-0.5 rtl:ml-0 rtl:mr-0.5 hidden md:inline" />
</button>
<ul
  class:list={[
    'dropdown-menu menu-dropdown md:backdrop-blur-md dark:md:bg-dark rounded md:absolute p-4 md:bg-white/90 md:min-w-[200px] drop-shadow-xl text-[13px] lg:text-[14px] xl:text-[15px] 2xl:text-[16px] !flex flex-wrap left-[-100vw] right-[-100vw] w-[96vw] mx-auto max-w-[1800px]',
    {'max-w-[1200px]': btn._id === 'kit-consulting'}
  ]}
>
  {
    getLinks(links).map(({ text: text2, href: href2, title: title2, links: subLinks, colsClass }) => (
      <li class:list={['lg:flex-1 relative pb-8 w-1/2', { 'has-children': subLinks && subLinks.length > 0 }, { 'w-full': getLinks(links).length <= 1 }]}>
        {href2 ? (
          <a
            class:list={[
              'text-[16px] xl:text-[17px] font-bold leading-tight mb-2 font-heading dark:text-slate-300 hover:text-primary dark:hover:text-blue-700 transition ease-in duration-200 py-2 px-3 xl:px-5 block whitespace-no-wrap',
              { 'active':  breadcrumbTrail && breadcrumbTrail[1] && breadcrumbTrail[1].text === text2 && breadcrumbTrail[1].href === href2},
            ]}
            href={href2}
            title={title2}
          >
            {text2}
          </a>
        ) : (
          <span class:list={[
              'text-[16px] xl:text-[17px] font-bold leading-tight mb-2 font-heading dark:text-slate-300 hover:text-primary dark:hover:text-blue-700 transition ease-in duration-200 py-2 px-3 xl:px-5 block whitespace-no-wrap',
              { 'active':  breadcrumbTrail && breadcrumbTrail[1] && breadcrumbTrail[1].text === text2 && breadcrumbTrail[1].href === href2},
            ]}>
            {text2}
          </span>
        )}

        {subLinks && subLinks.length > 0 && (
          <>
            <ul class={`dropdown-submenu pl-1 xl:pl-4 grid gap-x-3 lg:gap-x-4 ${colsClass ? colsClass : ''}`}>
              {subLinks.map(({ text: text3, href: href3, title: title3, icon: icon3 }) => (
                <li class="flex items-center space-x-2 mb-1">
                  <div class="mt-1">
                    <Icon
                      name={icon3 ? icon3 : 'tabler:check'}
                      class="w-7 h-7 lg:w-8 lg:h-8 font-bold p-1 text-primary"
                    />
                  </div>
                  <a
                    class:list={[
                      'block whitespace-no-wrap hover:text-link dark:hover:text-white dark:hover:bg-gray-700',
                      { 'active':  breadcrumbTrail && breadcrumbTrail[2] && breadcrumbTrail[2].text === text3 && breadcrumbTrail[2].href === href3},
                    ]}
                    href={href3}
                    title={title3}
                  >
                    {text3}
                  </a>
                </li>
              ))}
            </ul>

            {href2 && (
              <div class="text-end px-3 xl:px-5 absolute bottom-0 right-0">
                <a class="" href={href2} title={title2}>
                  {t('menu.more_info')}
                </a>
              </div>
            )}
          </>
        )}
      </li>
    ))
  }
</ul>
