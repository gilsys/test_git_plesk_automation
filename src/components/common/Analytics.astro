---
import { ANALYTICS } from 'astrowind:config';
import { languages } from '~/i18n/ui';

const googleAnalyticsId  = ANALYTICS.vendors.googleAnalytics.id;
---
<script is:inline define:vars={{ googleAnalyticsId }}>
  window.GOOGLE_ANALYTICS_ID = googleAnalyticsId;
</script>

<script>
  declare global {
    interface Window {
      dataLayer: Record<string, any>[];
      gtag: (...args: any[]) => void;
    }
  }

  function isMobile() {
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
  }

  function loadGTM() {
    if (window.gtmLoaded) return;
    window.gtmLoaded = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtm.js?id=${window.GOOGLE_ANALYTICS_ID}`;
    document.head.appendChild(script);

    script.onload = () => {
      window.dataLayer = window.dataLayer || [];
      window.gtag = function gtag() {
        window.dataLayer.push(arguments);
      };
      window.gtag("js", new Date());

      window.gtag("consent", "default", {
        ad_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
        analytics_storage: "denied",
      });
      
      window.gtag("config", window.GOOGLE_ANALYTICS_ID);
    };
  }

  if (isMobile()) {
    document.addEventListener("click", loadGTM, { once: true });
    document.addEventListener("scroll", loadGTM, { once: true });
    document.addEventListener("touchstart", loadGTM, { once: true });
  } else {
    loadGTM(); // Cargar en Desktop inmediatamente
  }
</script>

<script is:inline define:vars={{ languages: Object.keys(languages) }}>
  function addEvent(data) {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push(data);
  }

  document.addEventListener('astro:page-load', () => {
    addEvent({
      event: 'page_view',
      page_path: window.location.pathname,
      page_title: document.title,
    });

    document.querySelectorAll('[href]').forEach((item) => {
      item.addEventListener('click', (e) => {
        const link = e.target.closest('[href]');
        const [, lang] = window.location.pathname.split('/');

        const section = link.closest('section');
        let sectionTitle = section?.querySelector('h1, h2, h3')?.textContent.trim() || null;

        if(!sectionTitle) {
          if(link.closest('header')) {
            sectionTitle = 'Header';
          } else if(link.closest('footer')) {
            sectionTitle = 'Footer';
          }
        }

        addEvent({
          event: 'link_click',
          href: link.getAttribute('href'),
          text: link.textContent.trim(),
          title: link.getAttribute('title')?.trim() || null,
          lang: languages.includes(lang) ? lang : null,
          page: window.location.pathname,
          section: sectionTitle
        });
      });
    });
  });
</script>
